(function(a){Timeline={};if(Object.create===undefined){Object.create=function(e,c){var b;if(typeof(e)!=="object"&&e!==null){throw new TypeError()}function d(){}d.prototype=e;b=new d();if(typeof(c)==="object"){for(var f in c){if(c.hasOwnProperty((f))){b[f]=c[f]}}}return b}}if(Object.getPrototypeOf===undefined){if(typeof"test".__proto__==="object"){Object.getPrototypeOf=function(b){return b.__proto__}}else{Object.getPrototypeOf=function(b){return b.constructor.prototype}}}Timeline.Util={};Timeline.Util.inherits=function(b,c){b.super_=c;b.prototype=Object.create(c.prototype)};Timeline.View=function(){this._element=a('<div class="'+this._getClassName()+'"></div>');this._element.appendTo("body").hide();this._element.data("view",this)};Timeline.View.prototype.getElement=function(){return this._element};Timeline.View.prototype._build=function(){};Timeline.View.prototype._postShow=function(){};Timeline.View.prototype.render=function(){this._build();this._element.show();this._postShow();return this._element};Timeline.View.prototype.isContainY=function(d){var b=this._element.offset().top;var c=b+this._element.height();return b<=d&&d<=c};Timeline.EventView=function(e,d){var c=this;Timeline.EventView.super_.call(c);c._timeSpan=e;c._lineView=null;c._element.css("position","relative");c._element.addClass(d);c._startMinView=null;c._endMinView=null;var b=null;c._element.draggable({helper:"clone",create:function(f,g){Timeline.EventView.dragging=null;c._element.draggable("option","revertDuration",150)},start:function(f,g){Timeline.EventView.dragging={ui:g,eventView:c};b=c.getLineView();g.helper.width(c._element.width());c._element.draggable("option","revert",false)},stop:function(f,g){Timeline.EventView.dragging=null;Timeline.timeIndicator.hide()},drag:function(f,g){Timeline.LineView.currentLineView.showTimeIndicator(g.helper.offset().top)}});c._element.append('<div class="start time" />');c._displayElement=a('<div class="display" />');c._element.append(c._displayElement);c._element.append('<div class="end time" />');c._element.find(".time").css({cursor:"default"})};Timeline.Util.inherits(Timeline.EventView,Timeline.View);Timeline.EventView.CLASS_ELEM="tlEventView";Timeline.EventView.create=function(d,b,c){return new Timeline.EventView(Timeline.TimeSpan.create(d,b),c)};Timeline.EventView.prototype._getClassName=function(){return Timeline.EventView.CLASS_ELEM};Timeline.EventView.prototype.getTimeSpan=function(){return this._timeSpan};Timeline.EventView.prototype.setTimeSpan=function(b){this._timeSpan=b;return this};Timeline.EventView.prototype.setLineView=function(b){this._lineView=b;return this};Timeline.EventView.prototype.getLineView=function(b){return this._lineView};Timeline.EventView.prototype.setStartMinView=function(b){this._startMinView=b;return this};Timeline.EventView.prototype.setEndMinView=function(b){this._endMinView=b;return this};Timeline.EventView.prototype._build=function(){this._lineView.getLineElement().append(this._element)};Timeline.EventView.prototype.updateDisplay=function(){var d=this;var c=d._startMinView.getTopPosition(d._timeSpan.getStartTime().getMin());var b=d._endMinView.getTopPosition(d._timeSpan.getEndTime().getMin());var f=d._element.offset();f.top=c;d._element.offset(f);d._element.height(b-c-1);var e=d._element.find(".time");e.filter(".start").html(this._timeSpan.getStartTime().getDisplayTime());e.filter(".end").html(this._timeSpan.getEndTime().getDisplayTime());d._displayElement.outerHeight(this._element.height()-(e.outerHeight()*2)-4)};Timeline.EventView.prototype.setDisplayHtml=function(b){if(b instanceof jQuery){this._displayElement.children().remove().append(b)}else{this._displayElement.html(b)}};Timeline.EventView.prototype._postShow=function(){this.updateDisplay()};Timeline.HourView=function(c,b){Timeline.HourView.super_.call(this);this._hour=b;this._lineView=c;this._minViews=[]};Timeline.Util.inherits(Timeline.HourView,Timeline.View);Timeline.HourView.CLASS_ELEM="tlHourView";Timeline.HourView.prototype._getClassName=function(){return Timeline.HourView.CLASS_ELEM};Timeline.HourView.prototype.getHour=function(){return this._hour};Timeline.HourView.prototype.getDisplayHour=function(){return this._hour<24?this._hour:this._hour-24};Timeline.HourView.prototype.getMinView=function(c){var b;a.each(this._minViews,function(d,e){if(e.isContainMin(c)){b=e;return false}});return b};Timeline.HourView.prototype.addHeightPerMin=function(b){a.each(this._minViews,function(c,d){d.addHeightPerMin(b)});return this};Timeline.HourView.prototype.setHeightPerMin=function(b){a.each(this._minViews,function(c,d){d.setHeightPerMin(b)});return this};Timeline.HourView.prototype.getMinViewUnderY=function(c){var b=null;a.each(this._minViews,function(){if(this.isContainY(c)){b=this;return false}});return b};Timeline.HourView.prototype.getLineView=function(){return this._lineView};Timeline.HourView.prototype._build=function(){var e=15;var d=60/e;for(var c=0;c<d;c++){var b=new Timeline.MinView(this,c*e,e);this._minViews.push(b);this._element.append(b.render())}this._element.addClass("_"+this._hour)};Timeline.LineView=function(b){Timeline.LineView.super_.call(this);this._timeSpan=b;this._hourViews=[];this._lineElement=null;this._hoursWrapper=null;this._rulerElement=null;this._rulerView=null;this._lineWidth=60};Timeline.Util.inherits(Timeline.LineView,Timeline.View);Timeline.LineView.CLASS_ELEM="tlLineView";Timeline.LineView.EVENT_TOP_ALLOWANCE=20;Timeline.timeIndicator=null;Timeline.LineView.prototype._getClassName=function(){return Timeline.LineView.CLASS_ELEM};Timeline.LineView.prototype.setRulerView=function(b){this._rulerView=b;this._rulerView.setLineView(this);this._rulerView.render();this._updateDisplay()};Timeline.LineView.prototype.eachHourView=function(b){a.each(this._hourViews,b)};Timeline.LineView.prototype.getLineElement=function(){return this._lineElement};Timeline.LineView.prototype._build=function(){var d=this;if(!Timeline.timeIndicator){Timeline.timeIndicator=a('<div id="tlTimeIndicator" />').appendTo("body").css({position:"absolute"}).hide()}d._lineElement=a('<div class="tlTimeline" />').appendTo(d._element);d._hoursWrapper=a('<div class="tlHours" />').appendTo(d._lineElement);d._lineElement.bind("mouseenter",function(f){if(Timeline.timeIndicator.is(":hidden")){Timeline.timeIndicator.show()}}).bind("mouseleave",function(){Timeline.timeIndicator.hide()}).bind("mousemove",function(f){if(!Timeline.EventView.dragging){d.showTimeIndicator(f.pageY)}});d._hoursWrapper.droppable({accept:".tlEventView",drop:function(f,n){var m=d._hoursWrapper.closest(".tlLineView").data("view");var g=n.draggable.data("view");var i=Timeline.timeIndicator.data("time");if(!i){n.draggable.draggable("option","revert",true);return false}var k=g.getTimeSpan();var p=k.shiftStartTime(i);if(!m.getTimeSpan().isOverlapTime(p.getStartTime(),true)){p=p.shiftStartTime(m.getTimeSpan().getStartTime())}if(!m.getTimeSpan().isOverlapTime(p.getEndTime())){p=p.shiftEndTime(m.getTimeSpan().getEndTime())}var o=d.getEventViewAtTime(p.getStartTime(),g,true);if(o){p=p.shiftStartTime(o.getTimeSpan().getEndTime())}var l=d.getEventViewAtTime(p.getEndTime(),g);if(o&&l){n.draggable.draggable("option","revert",true);return false}else{if(l){p=p.shiftEndTime(l.getTimeSpan().getStartTime())}}var j=false;m.eachEventView(function(r,q){if(p.isContainTimeSpan(q.getTimeSpan())){j=true;return false}});if(j){n.draggable.draggable("option","revert",true);return false}g.setTimeSpan(p);var h=g.getLineView();m.addEventView(g);h.eachEventView(function(r,q){q.updateDisplay()})},over:function(f,g){Timeline.LineView.currentLineView=d}});var e=null;d._timeSpan.eachHour(function(g,f){e=new Timeline.HourView(d,f);d._hoursWrapper.append(e.render());d._hourViews.push(e)});var b=".tlMinView";var c=d._timeSpan.getEndTime().getMin();if(0<=c&&c<15){b+=":not(._15)"}else{if(15<=c&&c<30){b+=":not(._15, ._30)"}else{if(30<=c&&c<45){b+=":not(._15, ._30, ._45)"}else{if(45<=c&&c<60){b+=":not(._15, ._30, ._45, ._60)"}}}}e.getElement().children(b).remove()};Timeline.LineView.prototype.showTimeIndicator=function(e){var d=this._hourViews[0].getElement().find(".tlMinView:first").offset().top;if(e<d&&d-e<Timeline.LineView.EVENT_TOP_ALLOWANCE){e=d}var b=this.getTimeUnderY(e);if(b){Timeline.timeIndicator.data("time",b);var c=this._hoursWrapper.offset();c.top=e-(Timeline.timeIndicator.height()/2);c.left=c.left-Timeline.timeIndicator.outerWidth();Timeline.timeIndicator.offset(c);Timeline.timeIndicator.html(b.getDisplayTime())}};Timeline.LineView.prototype.getTimeSpan=function(){return this._timeSpan};Timeline.LineView.prototype.getTimeUnderY=function(d){var c=this.getHourViewUnderY(d);if(c===null){return null}var b=c.getMinViewUnderY(d);if(b===null){return null}return b.getTimeUnderY(d)};Timeline.LineView.prototype.getEventViewAtTime=function(d,c,e){var b=null;this.eachEventView(function(g,f){if(f.getTimeSpan().isOverlapTime(d,e)){b=f;return false}});if(c===b){return null}return b};Timeline.LineView.prototype.getHourViewUnderY=function(c){var b=null;a.each(this._hourViews,function(){if(this.isContainY(c)){b=this;return false}});return b};Timeline.LineView.prototype._postShow=function(){this._updateDisplay()};Timeline.LineView.prototype.addEventView=function(b){b.setLineView(this);var c=b.getTimeSpan();b.setStartMinView(this._getMinView(c.getStartTime()));b.setEndMinView(this._getMinView(c.getEndTime()));b.render();return this};Timeline.LineView.prototype._getMinView=function(c){var b;a.each(this._hourViews,function(d,e){if(e.getHour()===c.getHour()){b=e.getMinView(c.getMin());return false}});return b};Timeline.LineView.prototype.addLineWidth=function(b){this._lineWidth+=b;this._updateDisplay();return this};Timeline.LineView.prototype.setLineWidth=function(b){this._lineWidth=b;this._updateDisplay();return this};Timeline.LineView.prototype.addHeightPerMin=function(b){a.each(this._hourViews,function(c,d){d.addHeightPerMin(b)});this._updateRulerDisplay();this._updateEventsDisplay();this._updateDisplay();return this};Timeline.LineView.prototype.setHeightPerMin=function(b){a.each(this._hourViews,function(c,d){d.setHeightPerMin(b)});this._updateRulerDisplay();this._updateEventsDisplay();this._updateDisplay();return this};Timeline.LineView.prototype._updateDisplay=function(){var b=this;b._lineElement.width(b._lineWidth);if(b._rulerView){b._element.width(b._lineWidth+Timeline.RulerView.DEFAULT_WIDTH)}else{b._element.width(b._lineWidth)}setTimeout(function(){var c=b._hoursWrapper.height();b._lineElement.css({height:c,overflow:"hidden"})},0)};Timeline.LineView.prototype.eachEventView=function(b){this._element.find(".tlEventView:not(.ui-draggable-dragging)").each(function(d){var c=a(this).data("view");if(b.call(c,d,c)===false){return}})};Timeline.LineView.prototype._updateEventsDisplay=function(){this.eachEventView(function(c,b){b.updateDisplay()})};Timeline.LineView.prototype._updateRulerDisplay=function(){if(this._rulerView===null){return}this._rulerView.updateDisplay()};Timeline.MinView=function(c,b,d){Timeline.MinView.super_.call(this);this._hourView=c;this._min=b;this._minUnit=d;this._heightPerMin=1};Timeline.Util.inherits(Timeline.MinView,Timeline.View);Timeline.MinView.CLASS_ELEM="tlMinView";Timeline.MinView.prototype._getClassName=function(){return Timeline.MinView.CLASS_ELEM};Timeline.MinView.prototype.isContainMin=function(d){var c=this._min===0?0:this._min;var b=this._min+this._minUnit-1;return c<=d&&d<=b};Timeline.MinView.prototype.getHourView=function(){return this._hourView};Timeline.MinView.prototype.getTopPosition=function(b){var d=this._element.offset();var c=(b%this._minUnit)/this._minUnit;return d.top+(this._element.outerHeight()*c)-1};Timeline.MinView.prototype.getTimeUnderY=function(c){var b=this._min+((c-this._element.offset().top)*(this._minUnit/this._element.outerHeight()));return new Timeline.Time(this._hourView.getHour(),b)};Timeline.MinView.prototype.addHeightPerMin=function(b){var c=this._heightPerMin;c+=b;if(c<0.1){c=0.1}this.setHeightPerMin(c);return this};Timeline.MinView.prototype.setHeightPerMin=function(b){if(this._heightPerMin==b){return}this._heightPerMin=b;this._updateDisplay();return this};Timeline.MinView.prototype._updateDisplay=function(){this._element.height(this._heightPerMin*this._minUnit)};Timeline.MinView.prototype._build=function(){this._element.addClass("_"+(this._min+this._minUnit));this._updateDisplay()};Timeline.RulerView=function(){Timeline.RulerView.super_.call(this);this._lineView=null};Timeline.Util.inherits(Timeline.RulerView,Timeline.View);Timeline.RulerView.CLASS_ELEM="tlRulerView";Timeline.RulerView.DEFAULT_WIDTH=50;Timeline.RulerView.prototype._getClassName=function(){return Timeline.RulerView.CLASS_ELEM};Timeline.RulerView.prototype._build=function(){var b=this;b._lineView.getElement().prepend(b._element);b._element.width(Timeline.RulerView.DEFAULT_WIDTH);b._lineView.eachHourView(function(d,e){var c=a('<div class="hour">'+e.getDisplayHour()+":00</div>");b._element.append(c);c.css({cursor:"default"});c.data("hourView",e);c.height(e.getElement().outerHeight())})};Timeline.RulerView.prototype._postShow=function(){};Timeline.RulerView.prototype.updateDisplay=function(){this._element.children().each(function(){var b=a(this);var c=b.data("hourView");setTimeout(function(){b.height(c.getElement().outerHeight())},0)})};Timeline.RulerView.prototype.setLineView=function(b){b.getElement().addClass("hasRuler");this._lineView=b};Timeline.TemplateView=function(){Timeline.TemplateView.super_.call(this)};Timeline.Util.inherits(Timeline.TemplateView,Timeline.View);Timeline.TemplateView.CLASS_ELEM="tlTemplateView";Timeline.TemplateView.prototype._getClassName=function(){return Timeline.TemplateView.CLASS_ELEM};Timeline.TemplateView.prototype._build=function(){};Timeline.TemplateView.prototype._postShow=function(){};Timeline.Time=function(b,c){this._hour=b===undefined?0:parseInt(b,10);this._min=c===undefined?0:parseInt(c,10);if(!(this._hour>=0&&this._min>=0&&this._min<=59)){throw new Error(this.toString()+" is not valid time.")}};Timeline.Time.create=function(b,c){return new Timeline.Time(b,c)};Timeline.Time.prototype.getHour=function(){return this._hour};Timeline.Time.prototype.getMin=function(){return this._min};Timeline.Time.prototype.addMin=function(d){var f=this.getHour();var e=this.getMin();e+=d;if(e>59){var c=Math.floor(e/60);f+=c;e=Math.abs(e%60)}else{if(e<0){var b=Math.floor(e/60);f+=b;e=60-Math.abs(e%60);if(e===60){e=0}}}return new Timeline.Time(f,e)};Timeline.Time.prototype.isEqual=function(b){return this.getHour()===b.getHour()&&this.getMin()===b.getMin()};Timeline.Time.prototype.compare=function(b){if(this.getHour()>b.getHour()){return 1}else{if(this.getHour()<b.getHour()){return -1}else{if(this.getMin()>b.getMin()){return 1}else{if(this.getMin()<b.getMin()){return -1}}}}return 0};Timeline.Time.prototype.getDistance=function(d){var c=d.getHour();var b=c-this._hour;return(b*60)+(d.getMin()-this._min)};Timeline.Time.prototype.toString=function(){return this._hour+":"+(this._min<10?"0"+this._min:this._min)};Timeline.Time.prototype.getDisplayHour=function(){return this._hour<24?this._hour:this._hour-24};Timeline.Time.prototype.getDisplayTime=function(){return this.getDisplayHour()+":"+(this._min<10?"0"+this._min:this._min)};Timeline.TimeSpan=function(c,b){if(c.compare(b)>0){throw Error("The endTime is earlier than the startTime.")}this._startTime=c;this._endTime=b};Timeline.TimeSpan.create=function(c,b){return new Timeline.TimeSpan(new Timeline.Time(c[0],c[1]),new Timeline.Time(b[0],b[1]))};Timeline.TimeSpan.prototype.getDistance=function(){return this._startTime.getDistance(this._endTime)};Timeline.TimeSpan.prototype.getStartTime=function(){return this._startTime};Timeline.TimeSpan.prototype.getEndTime=function(){return this._endTime};Timeline.TimeSpan.prototype.shiftEndTime=function(b){return new Timeline.TimeSpan(b.addMin(-this.getDistance()),b)};Timeline.TimeSpan.prototype.shiftStartTime=function(b){return new Timeline.TimeSpan(b,b.addMin(this.getDistance()))};Timeline.TimeSpan.prototype.isOverlapTime=function(b,c){if(c){return this._startTime.compare(b)<=0&&this._endTime.compare(b)>=0}else{return this._startTime.compare(b)<0&&this._endTime.compare(b)>0}};Timeline.TimeSpan.prototype.isContainTimeSpan=function(b){return this.isOverlapTime(b.getStartTime())&&this.isOverlapTime(b.getEndTime())};Timeline.TimeSpan.prototype.eachHour=function(e){var c=this.getStartTime().getHour();var b=this.getEndTime().getHour();var d=0;while(true){e.call(c,d,c);if(c===b){break}c+=1;++d}};Timeline.TimeSpan.prototype.toString=function(){return this._startTime+"~"+this._endTime}})(jQuery);